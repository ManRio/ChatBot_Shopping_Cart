{% extends "base.html" %}

{% block content %}
<section class="product-grid">
  {% for p in catalog %}
    <article
      class="product-card"
      data-product-id="{{ p.id }}"
      data-product-name="{{ p.name }}"
      data-product-price="{{ '%.2f'|format(p.price) }} €"
      data-product-desc="{{ p.description or '' }}"
      data-product-img="{{ url_for('static', filename=(p.image if p.image else 'img/placeholder.png')) }}"
    >
      <div class="product-image">
        <img
          src="{{ url_for('static', filename=(p.image if p.image else 'img/placeholder.png')) }}"
          alt="{{ p.name }}"
          loading="lazy"
        />
      </div>

      <div class="product-body">
        <h3 class="product-title">{{ p.name }}</h3>
        <p class="product-price">{{ '%.2f'|format(p.price) }} €</p>

        <div class="product-actions">
          <button type="button" class="btn-secondary" data-open-product="{{ p.id }}">
            Ver
          </button>

          <form
            method="post"
            action="{{ url_for('add_to_cart', product_id=p.id) }}"
            class="inline-form"
            data-ajax="add-to-cart"
            data-product-id="{{ p.id }}"
          >
            <input type="hidden" name="quantity" value="1" />
            <button type="submit" class="btn-primary">Añadir</button>
          </form>

          <small class="muted">ID: {{ p.id }}</small>
        </div>
      </div>
    </article>
  {% endfor %}
</section>

<!-- FAB chat -->
<button
  id="chat-fab"
  class="chat-fab"
  type="button"
  aria-haspopup="dialog"
  aria-controls="chat-widget"
  aria-expanded="true"
>
  Chat
</button>

<section
  id="chat-widget"
  class="chat-widget"
  role="dialog"
  aria-label="Chat con el asistente"
>
  <header class="chat-widget-header">
    <div class="chat-widget-title">Asistente</div>
    <button
      id="chat-close"
      class="chat-widget-close"
      type="button"
      aria-label="Cerrar chat"
    >
      ×
    </button>
  </header>

  <div id="chat-messages" class="chat-widget-messages">
    {% for speaker, text in chat_history %}
      <div class="message {{ 'assistant' if speaker == 'bot' else 'user' }}">
        <strong>{{ 'Asistente' if speaker == 'bot' else 'Usuario' }}:</strong>

        {% if speaker == 'bot' %}
          <div class="assistant-message-content">{{ text | safe }}</div>
        {% else %}
          <p>{{ text | e }}</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <form method="post" class="chat-widget-form">
    <input
      type="text"
      name="message"
      placeholder="Escribe tu mensaje..."
      autocomplete="off"
    />
    <button type="submit">Enviar</button>
  </form>
</section>
{% endblock %}